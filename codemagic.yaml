workflows:
  build-and-test:
    name: Build and test
    instance_type: mac_mini_m1
    environment:
      groups:
        - firebase_credentials
        - config_credentials
      xcode: 14.3
    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: '{develop,main}'
          include: true
          source: false
      cancel_previous_builds: true
    working_directory: Hourglass
    max_build_duration: 4
    scripts:
        - name: Show Xcode version
          script: xcode-select -p
        - name: Show Destinations
          script: xcodebuild -project 'Hourglass.xcodeproj' -scheme 'Hourglass' -showdestinations
        - name: Show SDKs
          script: xcodebuild -showsdks
        - name: Pre-build configuration
          script: |
            echo $FIREBASE_IOS | base64 --decode > $CM_BUILD_DIR/Hourglass/Hourglass/GoogleService-Info.plist
            echo $CONFIG_IOS | base64 --decode > $CM_BUILD_DIR/Hourglass/Hourglass/Config.xcconfig
        - name: Build and test on device
          script: >
            xcodebuild clean test
            -project 'Hourglass.xcodeproj'
            -scheme 'HourglassCITesting'
            -destination 'platform=macOS,arch=x86_64'
            -sdk 'macosx13.3'
            -parallel-testing-enabled NO
            CODE_SIGN_IDENTITY=""
            CODE_SIGNING_REQUIRED=NO
            CODE_SIGNING_ALLOWED=NO
            | xcpretty && exit ${PIPESTATUS[0]}
